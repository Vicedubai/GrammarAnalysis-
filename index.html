import React, { useState, useEffect, useRef } from 'react';
import { Book, GitBranch, Layers, ArrowRightLeft, Type, Info, ChevronRight, ChevronDown, Plus, Trash2, Sparkles, Wand2, RefreshCw, MessageSquare, X, Send, Minimize2, Maximize2, ZoomIn, ZoomOut, CheckCircle, AlertTriangle, Stethoscope } from 'lucide-react';

// --- Types ---
type Constituent = {
  id: string;
  wordIndices: number[];
  label: string;
  function: string;
  notes: string;
};

type TreeNodeData = {
  label: string;
  text?: string;
  children?: TreeNodeData[];
  function?: string;
};

type AnalysisState = {
  sentence: string;
  constituents: Constituent[];
  treeData: TreeNodeData | null;
  functionalNotes: {
    theme: string;
    rheme: string;
    process: string;
    context: string;
  };
  tgNotes: {
    deepStructure: string;
    transformations: string[];
    surfaceStructure: string;
  };
  explanation: string;
  // New field for Grammar Check
  grammarCheck: {
    isChecked: boolean;
    isCorrect: boolean;
    correction: string | null;
    explanation: string;
  } | null;
};

type ChatMessage = {
  id: string;
  role: 'user' | 'ai';
  text: string;
  timestamp: number;
};

// --- Initial Data / Demo ---
const DEMO_SENTENCE = "The girl chased the dog";
const DEMO_TREE: TreeNodeData = {
  label: "S",
  children: [
    {
      label: "NP",
      function: "Subject",
      children: [
        { label: "Det", text: "The" },
        { label: "N", text: "girl" }
      ]
    },
    {
      label: "VP",
      function: "Predicate",
      children: [
        { label: "V", text: "chased" },
        {
          label: "NP",
          function: "Object",
          children: [
            { label: "Det", text: "the" },
            { label: "N", text: "dog" }
          ]
        }
      ]
    }
  ]
};

const DEMO_STATE: AnalysisState = {
  sentence: DEMO_SENTENCE,
  constituents: [
    { id: 'c1', wordIndices: [0, 1], label: 'NP', function: 'Subject', notes: 'Agent / Actor' },
    { id: 'c2', wordIndices: [2, 3, 4], label: 'VP', function: 'Predicate', notes: 'Action + Goal' },
    { id: 'c3', wordIndices: [2], label: 'V', function: 'Process', notes: 'Material Process' },
    { id: 'c4', wordIndices: [3, 4], label: 'NP', function: 'Object', notes: 'Goal' },
  ],
  treeData: DEMO_TREE,
  functionalNotes: {
    theme: "The girl (Unmarked Theme - Subject)",
    rheme: "chased the dog",
    process: "Material Process (Doing)",
    context: "Narrative statement about a past event."
  },
  tgNotes: {
    deepStructure: "[S [NP The girl] [VP [V chase] [NP the dog]]]",
    transformations: ["T-tense (past)", "No passive transformation applied"],
    surfaceStructure: "The girl chased the dog"
  },
  explanation: "Active voice is chosen to focus on the 'girl' as the agent of the action, rather than the 'dog' as the receiver. Syntactically, it follows standard S-V-O order.",
  grammarCheck: {
    isChecked: true,
    isCorrect: true,
    correction: null,
    explanation: "Standard SVO sentence, grammatically correct."
  }
};

const EMPTY_STATE: AnalysisState = {
  sentence: "",
  constituents: [],
  treeData: null,
  functionalNotes: { theme: "", rheme: "", process: "", context: "" },
  tgNotes: { deepStructure: "", transformations: [], surfaceStructure: "" },
  explanation: "",
  grammarCheck: null
};

const PDF_REFERENCE = {
  functional: {
    title: "Functional Grammar",
    content: "Functional grammar (Halliday) views language as social interaction. Key concepts include:\n\n1. Ideational Function (Content): Who does what to whom? (Actor, Process, Goal).\n2. Interpersonal Function (Interaction): Mood, modality, relationship between speaker and hearer.\n3. Textual Function (Message): Theme (starting point) vs. Rheme (what is said about the theme).",
    tip: "Identify the 'Theme' (usually the first element) and the 'Process' (the verb type: Material, Mental, Relational)."
  },
  ic: {
    title: "Immediate Constituent (IC) Grammar",
    content: "IC Grammar analyzes sentences by cutting them into binary parts (constituents) until reaching the smallest units (morphemes).\n\nLevel 1: Noun Phrase (Subject) + Verb Phrase (Predicate).\nLevel 2: Break down the VP into Verb + NP (Object).\nLevel 3: Break down NPs into Determiner + Noun.",
    tip: "Look for the biggest 'cut' first. Usually between the Subject and the rest of the sentence."
  },
  tg: {
    title: "Transformational-Generative (TG) Grammar",
    content: "TG Grammar (Chomsky) distinguishes between 'Deep Structure' (abstract meaning) and 'Surface Structure' (what we say).\n\nIt uses rules to generate structures and transformations (T-rules) to change them (e.g., Passive, Negative, Question transformations).",
    tip: "Start with the kernel sentence (Deep Structure). What operations turned it into the current sentence?"
  }
};

// --- GEMINI API INTEGRATION ---
const apiKey = ""; // Injected at runtime

const callGemini = async (prompt: string, retries = 3): Promise<string> => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  const payload = {
    contents: [{ parts: [{ text: prompt }] }]
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        if (retries > 0) {
            await new Promise(r => setTimeout(r, 1000 * (4 - retries))); // Backoff
            return callGemini(prompt, retries - 1);
        }
        throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (error) {
    console.error("Gemini API call failed", error);
    throw error;
  }
};

export default function SentenceAnalyzer() {
  const [state, setState] = useState<AnalysisState>(EMPTY_STATE);
  const [activeTab, setActiveTab] = useState<'unit' | 'ic' | 'functional' | 'tg' | 'explain'>('unit');
  const [selection, setSelection] = useState<number[]>([]);
  const [showInfo, setShowInfo] = useState<string | null>(null);
  
  // AI States
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isCheckingGrammar, setIsCheckingGrammar] = useState(false);
  const [isGeneratingVars, setIsGeneratingVars] = useState(false);
  const [generatedVars, setGeneratedVars] = useState<{passive: string, question: string}>({passive: "", question: ""});
  const [aiError, setAiError] = useState<string | null>(null);

  // Chat States
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [chatInput, setChatInput] = useState("");
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([
    { id: 'welcome', role: 'ai', text: "Hello! I'm your AI Grammar Tutor. I can help explain terms like 'Theme/Rheme', 'Deep Structure', or help you draw syntax trees. How can I assist you?", timestamp: Date.now() }
  ]);
  const [isChatSending, setIsChatSending] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);

  // Scroll to bottom of chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatMessages, isChatOpen]);

  // --- Helpers ---
  const words = state.sentence.trim().split(/\s+/);

  const handleWordClick = (index: number) => {
    if (selection.includes(index)) {
      setSelection(selection.filter(i => i !== index));
    } else {
      const newSel = [...selection, index].sort((a, b) => a - b);
      setSelection(newSel);
    }
  };

  const createConstituent = () => {
    if (selection.length === 0) return;
    const newId = Date.now().toString();
    const newConstituent: Constituent = {
      id: newId,
      wordIndices: selection,
      label: '?',
      function: '?',
      notes: ''
    };
    setState(prev => ({
      ...prev,
      constituents: [...prev.constituents, newConstituent]
    }));
    setSelection([]);
  };

  const updateConstituent = (id: string, field: keyof Constituent, value: any) => {
    setState(prev => ({
      ...prev,
      constituents: prev.constituents.map(c => c.id === id ? { ...c, [field]: value } : c)
    }));
  };

  const deleteConstituent = (id: string) => {
    setState(prev => ({
      ...prev,
      constituents: prev.constituents.filter(c => c.id !== id)
    }));
  };

  const loadDemo = () => {
    setState(DEMO_STATE);
    setGeneratedVars({passive: "", question: ""});
  };

  const clearAll = () => {
    setState(EMPTY_STATE);
    setSelection([]);
    setGeneratedVars({passive: "", question: ""});
  };

  // --- AI Handlers ---

  const handleGrammarCheck = async () => {
    if (!state.sentence) return;
    setIsCheckingGrammar(true);
    
    const prompt = `
      Check the grammar of this sentence: "${state.sentence}"
      Is it grammatically correct in standard English?
      Return strictly JSON:
      {
        "isCorrect": boolean,
        "correction": "Corrected sentence string if wrong, or null if correct",
        "explanation": "Brief explanation of the error or why it is correct (max 20 words)"
      }
    `;

    try {
      const resultText = await callGemini(prompt);
      const cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
      const data = JSON.parse(cleanJson);
      
      setState(prev => ({
        ...prev,
        grammarCheck: {
          isChecked: true,
          isCorrect: data.isCorrect,
          correction: data.correction,
          explanation: data.explanation
        }
      }));
    } catch (e) {
      console.error(e);
    } finally {
      setIsCheckingGrammar(false);
    }
  };

  const handleAutoAnalyze = async () => {
    if (!state.sentence) return;
    setIsAnalyzing(true);
    setAiError(null);

    const prompt = `
      Act as an expert linguist. Analyze this sentence: "${state.sentence}"
      
      Return a STRICT JSON object with this structure:
      {
        "constituents": [
          { "text": "exact phrase", "label": "e.g., NP", "function": "e.g., Subject", "notes": "brief note" }
        ],
        "treeData": {
           "label": "S",
           "children": [
              { "label": "NP", "function": "Subject", "children": [ { "label": "Det", "text": "The" }, ... ] },
              { "label": "VP", "function": "Predicate", "children": [...] }
           ]
        },
        "functionalNotes": {
          "theme": "Identify Theme",
          "rheme": "Identify Rheme",
          "process": "Process Type",
          "context": "Context/Mood"
        },
        "tgNotes": {
          "deepStructure": "Deep structure string",
          "transformations": ["list", "of", "rules"],
          "surfaceStructure": "Original sentence"
        },
        "explanation": "Brief synthesis explaining the structure."
      }
      IMPORTANT: 'treeData' must be a recursive object. Leaf nodes must have 'text' property containing the word.
    `;

    try {
      const resultText = await callGemini(prompt);
      const cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
      const data = JSON.parse(cleanJson);

      const currentWords = state.sentence.trim().split(/\s+/);
      const mappedConstituents: Constituent[] = data.constituents ? data.constituents.map((c: any, idx: number) => {
        const constituentWords = c.text.split(/\s+/);
        const startIndex = currentWords.findIndex((w, i) => 
           w.replace(/[.,!?;:]/g,'').toLowerCase() === constituentWords[0].replace(/[.,!?;:]/g,'').toLowerCase() && 
           currentWords[i + constituentWords.length - 1]?.replace(/[.,!?;:]/g,'').toLowerCase() === constituentWords[constituentWords.length - 1]?.replace(/[.,!?;:]/g,'').toLowerCase()
        );
        let indices: number[] = [];
        if (startIndex !== -1) {
            for(let i=0; i<constituentWords.length; i++) indices.push(startIndex + i);
        }
        return {
          id: `ai-${idx}-${Date.now()}`,
          wordIndices: indices.length > 0 ? indices : [], 
          label: c.label || "phrase",
          function: c.function || "unknown",
          notes: c.notes || ""
        };
      }).filter((c: Constituent) => c.wordIndices.length > 0) : [];

      setState(prev => ({
        ...prev,
        constituents: mappedConstituents,
        treeData: data.treeData,
        functionalNotes: data.functionalNotes,
        tgNotes: data.tgNotes,
        explanation: data.explanation
      }));

    } catch (e) {
      setAiError("Failed to analyze. Please try again.");
      console.error(e);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleGenerateVariations = async () => {
    if (!state.sentence) return;
    setIsGeneratingVars(true);
    const prompt = `For sentence: "${state.sentence}", generate Passive and Question versions. Return JSON: { "passive": "", "question": "" }`;
    try {
      const text = await callGemini(prompt);
      const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
      setGeneratedVars(JSON.parse(cleanJson));
    } catch (e) { console.error(e); } 
    finally { setIsGeneratingVars(false); }
  };

  const handleGenerateSynthesis = async () => {
    if (!state.sentence) return;
    const prompt = `Write a grammatical synthesis for "${state.sentence}" combining Functional, IC, and TG perspectives.`;
    try {
      const text = await callGemini(prompt);
      setState(prev => ({ ...prev, explanation: text }));
    } catch (e) { console.error(e); }
  };

  const handleSendMessage = async (e?: React.FormEvent) => {
    e?.preventDefault();
    if (!chatInput.trim() || isChatSending) return;
    const newUserMsg: ChatMessage = { id: Date.now().toString(), role: 'user', text: chatInput, timestamp: Date.now() };
    setChatMessages(prev => [...prev, newUserMsg]);
    setChatInput("");
    setIsChatSending(true);
    
    // Check language of input roughly
    const isVietnamese = /[àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]/i.test(newUserMsg.text);

    const prompt = `
      Context: User is analyzing "${state.sentence || 'No sentence'}" using a syntax app.
      User Question: "${newUserMsg.text}"
      Answer as a Linguistics Tutor. Explain simply. If specific terms (Theme/Rheme) are mentioned, define them.
      ${isVietnamese ? "ANSWER IN VIETNAMESE." : "Answer in English."}
    `;
    try {
      const text = await callGemini(prompt);
      setChatMessages(prev => [...prev, { id: (Date.now()+1).toString(), role: 'ai', text, timestamp: Date.now() }]);
    } catch (e) {
      setChatMessages(prev => [...prev, { id: (Date.now()+1).toString(), role: 'ai', text: "Error connecting.", timestamp: Date.now() }]);
    } finally { setIsChatSending(false); }
  };

  // --- Tree Rendering Component ---
  const TreeRenderer = ({ node }: { node: TreeNodeData }) => {
    if (!node) return null;
    const isLeaf = !node.children || node.children.length === 0;

    return (
      <div className="flex flex-col items-center">
        {/* Node Label */}
        <div className={`
          border-2 rounded-lg px-3 py-1.5 bg-white text-center relative z-10 transition-all hover:scale-105
          ${isLeaf ? 'border-indigo-200 shadow-sm' : 'border-slate-800 bg-slate-50 font-bold'}
        `}>
          <span className={`${isLeaf ? 'text-indigo-600 font-bold' : 'text-slate-800'}`}>
            {node.label}
          </span>
          {node.function && (
            <div className="text-[10px] text-slate-400 uppercase tracking-wider font-normal">
              {node.function}
            </div>
          )}
          {node.text && (
            <div className="mt-1 text-slate-800 italic border-t border-indigo-100 pt-1">
              "{node.text}"
            </div>
          )}
        </div>

        {/* Children & Lines */}
        {!isLeaf && node.children && (
          <div className="flex flex-col items-center w-full">
            {/* Vertical line from parent */}
            <div className="h-6 w-px bg-slate-400"></div>
            
            {/* Horizontal connector */}
            <div className="relative w-full flex justify-center">
               <div className="flex gap-4 sm:gap-8 pt-4 relative">
                  {node.children.map((child, idx) => (
                    <div key={idx} className="flex flex-col items-center relative">
                      {/* Connecting lines */}
                      <div className="absolute top-[-1rem] w-full h-4">
                         {/* Left/Right connectors */}
                         <div className={`h-px bg-slate-400 absolute top-0 
                           ${idx === 0 ? 'left-1/2 w-1/2' : ''} 
                           ${idx === node.children!.length - 1 ? 'right-1/2 w-1/2' : ''}
                           ${(idx > 0 && idx < node.children!.length - 1) ? 'w-full' : ''}
                         `}></div>
                         {/* Vertical down to child */}
                         <div className="absolute left-1/2 top-0 h-4 w-px bg-slate-400 -translate-x-1/2"></div>
                      </div>
                      <TreeRenderer node={child} />
                    </div>
                  ))}
               </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // --- Components ---

  const ReferenceModal = () => {
    if (!showInfo) return null;
    // @ts-ignore
    const data = PDF_REFERENCE[showInfo];
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 animate-in fade-in zoom-in duration-200">
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
              <Book className="w-5 h-5" /> {data.title}
            </h3>
            <button onClick={() => setShowInfo(null)} className="text-gray-400 hover:text-gray-600">✕</button>
          </div>
          <div className="prose prose-sm text-gray-600 whitespace-pre-line mb-4">
            {data.content}
          </div>
          <div className="bg-indigo-50 p-3 rounded-md border-l-4 border-indigo-500 text-sm text-indigo-700">
            <strong>Tip:</strong> {data.tip}
          </div>
        </div>
      </div>
    );
  };

  const ChatWindow = () => {
    if (!isChatOpen) {
      return (
        <button
          onClick={() => setIsChatOpen(true)}
          className="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-xl hover:bg-indigo-700 hover:scale-105 transition-all z-50 flex items-center gap-2"
        >
          <MessageSquare size={24} />
          <span className="font-bold hidden sm:inline">Ask AI Tutor</span>
        </button>
      );
    }

    return (
      <div className="fixed bottom-6 right-6 w-full max-w-sm sm:w-96 bg-white rounded-xl shadow-2xl border border-indigo-100 flex flex-col z-50 animate-in slide-in-from-bottom-5 duration-300 h-[500px]">
        <div className="p-4 bg-indigo-600 text-white rounded-t-xl flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Sparkles size={18} className="text-yellow-300" />
            <span className="font-bold">Grammar Tutor</span>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => setIsChatOpen(false)} className="hover:text-indigo-200"><Minimize2 size={18} /></button>
            <button onClick={() => setIsChatOpen(false)} className="hover:text-indigo-200"><X size={18} /></button>
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
          {chatMessages.map((msg) => (
            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[85%] rounded-lg p-3 text-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-slate-700 border border-slate-200 shadow-sm rounded-bl-none'}`}>
                {msg.text}
              </div>
            </div>
          ))}
          {isChatSending && <div className="text-xs text-slate-400 italic">AI is typing...</div>}
          <div ref={chatEndRef} />
        </div>
        <form onSubmit={handleSendMessage} className="p-3 border-t border-slate-200 bg-white rounded-b-xl flex gap-2">
          <input
            type="text"
            value={chatInput}
            onChange={(e) => setChatInput(e.target.value)}
            placeholder="Ask about grammar..."
            className="flex-1 text-sm p-2 border border-slate-300 rounded-md focus:outline-none focus:border-indigo-500"
          />
          <button type="submit" disabled={!chatInput.trim() || isChatSending} className="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 disabled:opacity-50">
            <Send size={18} />
          </button>
        </form>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      <ReferenceModal />
      <ChatWindow />
      
      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="bg-indigo-600 text-white p-2 rounded-lg shadow-indigo-200 shadow-lg">
              <GitBranch size={20} />
            </div>
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 hidden sm:block">
              Structural Syntax Analyzer
            </h1>
            <h1 className="text-xl font-bold text-indigo-600 sm:hidden">Syntax Analyzer</h1>
          </div>
          <div className="flex items-center gap-2 sm:gap-3">
            <button 
              onClick={handleAutoAnalyze}
              disabled={!state.sentence || isAnalyzing}
              className="flex items-center gap-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:shadow-lg hover:shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all animate-in fade-in"
            >
              {isAnalyzing ? <RefreshCw className="animate-spin w-4 h-4" /> : <Sparkles className="w-4 h-4" />}
              <span className="hidden sm:inline">AI Analyze</span>
              <span className="sm:hidden">AI</span>
            </button>
            <div className="h-6 w-px bg-slate-300 mx-1"></div>
            <button 
              onClick={loadDemo}
              className="text-sm font-medium text-slate-600 hover:text-indigo-600 px-2 sm:px-3 py-1.5 rounded-md hover:bg-slate-50 transition-colors"
            >
              Demo
            </button>
            <button 
              onClick={clearAll}
              className="text-sm font-medium text-red-500 hover:text-red-700 px-2 sm:px-3 py-1.5 rounded-md hover:bg-red-50 transition-colors"
            >
              Clear
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
        
        {/* Input Area */}
        <section className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
          {isAnalyzing && (
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 animate-shimmer" style={{backgroundSize: '200% 100%'}}></div>
          )}
          <label className="block text-sm font-semibold text-slate-500 mb-2 uppercase tracking-wide flex justify-between">
            <span>Sentence to Analyze</span>
            {aiError && <span className="text-red-500 text-xs normal-case">{aiError}</span>}
          </label>
          <div className="relative">
            <input 
              type="text" 
              value={state.sentence}
              onChange={(e) => {
                setState({...state, sentence: e.target.value, grammarCheck: null}); // Reset grammar check on change
              }}
              placeholder="Type your sentence here... (e.g., The bird is singing)"
              className="w-full text-xl p-4 pr-32 border-2 border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-0 transition-all outline-none"
            />
            {state.sentence && (
              <button 
                onClick={handleGrammarCheck}
                disabled={isCheckingGrammar}
                className="absolute right-2 top-2 bottom-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded flex items-center gap-2 text-sm font-medium transition-colors"
              >
                {isCheckingGrammar ? <RefreshCw className="animate-spin w-4 h-4"/> : <Stethoscope className="w-4 h-4"/>}
                Check
              </button>
            )}
          </div>

          {/* Grammar Check Result Alert */}
          {state.grammarCheck && (
            <div className={`mt-4 p-4 rounded-lg border flex items-start gap-3 animate-in fade-in slide-in-from-top-2 ${
              state.grammarCheck.isCorrect 
                ? 'bg-green-50 border-green-200 text-green-800' 
                : 'bg-amber-50 border-amber-200 text-amber-800'
            }`}>
              {state.grammarCheck.isCorrect ? <CheckCircle className="shrink-0 w-5 h-5 text-green-600 mt-0.5" /> : <AlertTriangle className="shrink-0 w-5 h-5 text-amber-600 mt-0.5" />}
              <div>
                <h4 className="font-bold text-sm uppercase mb-1">
                  {state.grammarCheck.isCorrect ? "Grammatically Correct" : "Possible Error Detected"}
                </h4>
                <p className="text-sm">{state.grammarCheck.explanation}</p>
                {!state.grammarCheck.isCorrect && state.grammarCheck.correction && (
                  <div className="mt-2 text-sm bg-white/50 p-2 rounded border border-amber-200/50">
                    <strong>Suggestion:</strong> <span className="italic">"{state.grammarCheck.correction}"</span>
                  </div>
                )}
              </div>
            </div>
          )}
        </section>

        {/* Workspace Tabs */}
        {state.sentence && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[600px] flex flex-col">
            <div className="flex border-b border-slate-200 bg-slate-50 overflow-x-auto no-scrollbar">
              {[
                { id: 'unit', label: '1. Identify Units', icon: Layers },
                { id: 'ic', label: '2. Tree Diagram (IC)', icon: GitBranch },
                { id: 'functional', label: '3. Functional', icon: ArrowRightLeft },
                { id: 'tg', label: '4. TG Grammar', icon: Type },
                { id: 'explain', label: '5. Synthesis', icon: Book },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`flex items-center gap-2 px-4 sm:px-6 py-4 text-sm font-medium whitespace-nowrap transition-all border-b-2 ${
                    activeTab === tab.id 
                      ? 'border-indigo-600 text-indigo-700 bg-white' 
                      : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100'
                  }`}
                >
                  <tab.icon size={16} />
                  {tab.label}
                </button>
              ))}
            </div>

            <div className="p-4 sm:p-6 flex-1 bg-white">
              
              {/* --- VIEW: UNITS (MANUAL SELECTION) --- */}
              {activeTab === 'unit' && (
                <div className="space-y-8">
                  <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800 flex gap-3">
                    <Info className="shrink-0 w-5 h-5 text-blue-500" />
                    <p>
                      <strong>Step 1:</strong> Identify grammatical units manually. Click words below to select them, then click "Create Constituent".
                      If you need help, click <strong>"AI Analyze"</strong> above to see the AI's breakdown.
                    </p>
                  </div>

                  <div className="flex flex-wrap gap-2 p-6 bg-slate-50 rounded-xl border border-slate-200 justify-center">
                    {words.map((word, idx) => (
                      <button
                        key={idx}
                        onClick={() => handleWordClick(idx)}
                        className={`px-4 py-2 rounded-md text-lg transition-all ${
                          selection.includes(idx) 
                            ? 'bg-indigo-600 text-white shadow-lg scale-105' 
                            : 'bg-white text-slate-700 hover:bg-indigo-50 border border-slate-200'
                        }`}
                      >
                        {word}
                      </button>
                    ))}
                  </div>

                  <div className="flex justify-center">
                    <button 
                      onClick={createConstituent}
                      disabled={selection.length === 0}
                      className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-2 rounded-full font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                    >
                      <Plus size={18} /> Create Constituent
                    </button>
                  </div>

                  <div className="space-y-4">
                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                      Identified Units <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">{state.constituents.length}</span>
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {state.constituents.map((c) => (
                        <div key={c.id} className="p-4 rounded-lg border border-slate-200 bg-slate-50 hover:shadow-md transition-shadow group relative">
                          <button 
                            onClick={() => deleteConstituent(c.id)}
                            className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            <Trash2 size={16} />
                          </button>
                          
                          <div className="font-medium text-lg text-indigo-900 mb-3 pb-2 border-b border-slate-200">
                            "{c.wordIndices.map(i => words[i]).join(' ')}"
                          </div>
                          
                          <div className="space-y-3">
                            <div>
                              <label className="text-xs font-bold text-slate-400 uppercase">Grammatical Unit</label>
                              <input 
                                type="text" 
                                value={c.label}
                                onChange={(e) => updateConstituent(c.id, 'label', e.target.value)}
                                placeholder="e.g., NP, VP, Clause"
                                className="w-full text-sm p-1.5 bg-white border border-slate-300 rounded focus:border-indigo-500 focus:outline-none mt-1"
                              />
                            </div>
                            <div>
                              <label className="text-xs font-bold text-slate-400 uppercase">Syntactic Function</label>
                              <input 
                                type="text" 
                                value={c.function}
                                onChange={(e) => updateConstituent(c.id, 'function', e.target.value)}
                                placeholder="e.g., Subject, Predicate"
                                className="w-full text-sm p-1.5 bg-white border border-slate-300 rounded focus:border-indigo-500 focus:outline-none mt-1"
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                      {state.constituents.length === 0 && (
                        <div className="col-span-full py-10 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-lg">
                          No constituents identified yet. Select words above to begin manually.
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* --- VIEW: IC GRAMMAR (TREE) --- */}
              {activeTab === 'ic' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-start">
                    <div>
                      <h2 className="text-lg font-bold text-slate-800">Immediate Constituent Analysis</h2>
                      <p className="text-sm text-slate-500">Tree Diagram showing hierarchical structure.</p>
                    </div>
                    <button onClick={() => setShowInfo('ic')} className="text-indigo-600 hover:text-indigo-800 flex items-center gap-1 text-sm font-medium">
                      <Info size={16} /> What is IC?
                    </button>
                  </div>
                  
                  {/* TREE RENDERER */}
                  <div className="bg-slate-50 p-8 rounded-xl border border-slate-200 min-h-[400px] flex items-start justify-center relative overflow-auto">
                    {state.treeData ? (
                      <div className="scale-90 origin-top">
                        <TreeRenderer node={state.treeData} />
                      </div>
                    ) : (
                      <div className="text-slate-400 italic mt-20 flex flex-col items-center">
                        <GitBranch size={48} className="mb-4 opacity-20" />
                        <p>No tree data yet. Click <strong>"AI Analyze"</strong> to generate.</p>
                      </div>
                    )}
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-white p-4 rounded-lg border border-slate-200">
                       <h4 className="font-semibold text-slate-700 mb-2">Binary Cuts Explainer</h4>
                       <textarea 
                         placeholder="Why cut here? (e.g., Splitting Subject and Predicate...)"
                         className="w-full h-32 p-3 text-sm bg-slate-50 border border-slate-200 rounded-md focus:border-indigo-500 focus:outline-none"
                         defaultValue={state.explanation ? `Notes on structure: ${state.explanation}` : ''}
                       />
                    </div>
                    <div className="bg-white p-4 rounded-lg border border-slate-200">
                       <h4 className="font-semibold text-slate-700 mb-2">Ambiguity Check</h4>
                       <p className="text-sm text-slate-600 mb-2">
                         Can this sentence be parsed into two different trees? (e.g., "old men and women")
                       </p>
                       <textarea 
                         className="w-full h-32 p-3 text-sm bg-slate-50 border border-slate-200 rounded-md focus:border-indigo-500 focus:outline-none"
                         placeholder="Notes on different interpretations..."
                       />
                    </div>
                  </div>
                </div>
              )}

              {/* --- VIEW: FUNCTIONAL --- */}
              {activeTab === 'functional' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-start">
                    <h2 className="text-lg font-bold text-slate-800">Functional Grammar</h2>
                    <button onClick={() => setShowInfo('functional')} className="text-indigo-600 hover:text-indigo-800 flex items-center gap-1 text-sm font-medium">
                      <Info size={16} /> Halliday's Framework
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {/* Theme/Rheme */}
                    <div className="col-span-1 md:col-span-3 lg:col-span-1 space-y-4">
                      <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-100">
                        <h3 className="font-bold text-emerald-900 mb-2">Textual: Theme & Rheme</h3>
                        <p className="text-xs text-emerald-700 mb-3">Theme is the starting point of the message.</p>
                        <div className="space-y-3">
                          <div>
                            <label className="text-xs font-semibold text-emerald-800">Theme</label>
                            <input 
                              type="text" 
                              value={state.functionalNotes.theme}
                              onChange={(e) => setState({...state, functionalNotes: {...state.functionalNotes, theme: e.target.value}})}
                              className="w-full mt-1 p-2 border border-emerald-200 rounded bg-white text-sm"
                              placeholder="e.g., The girl"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-emerald-800">Rheme</label>
                            <input 
                              type="text" 
                              value={state.functionalNotes.rheme}
                              onChange={(e) => setState({...state, functionalNotes: {...state.functionalNotes, rheme: e.target.value}})}
                              className="w-full mt-1 p-2 border border-emerald-200 rounded bg-white text-sm"
                              placeholder="e.g., chased the dog"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Transitivity */}
                    <div className="col-span-1 md:col-span-3 lg:col-span-1 space-y-4">
                       <div className="bg-amber-50 p-4 rounded-lg border border-amber-100">
                        <h3 className="font-bold text-amber-900 mb-2">Ideational: Transitivity</h3>
                        <p className="text-xs text-amber-700 mb-3">Who does what to whom? (Process Types)</p>
                        <div>
                            <label className="text-xs font-semibold text-amber-800">Process Type</label>
                            <select 
                              className="w-full mt-1 p-2 border border-amber-200 rounded bg-white text-sm"
                              value={state.functionalNotes.process}
                              onChange={(e) => setState({...state, functionalNotes: {...state.functionalNotes, process: e.target.value}})}
                            >
                              <option value="">Select Process...</option>
                              <option value="Material">Material (Doing)</option>
                              <option value="Mental">Mental (Sensing/Thinking)</option>
                              <option value="Relational">Relational (Being/Having)</option>
                              <option value="Verbal">Verbal (Saying)</option>
                              <option value="Existential">Existential (Existing)</option>
                            </select>
                        </div>
                        <div className="mt-3">
                          <label className="text-xs font-semibold text-amber-800">Participants</label>
                          <textarea 
                             className="w-full mt-1 p-2 border border-amber-200 rounded bg-white text-sm h-20"
                             placeholder="e.g., Actor: The girl, Goal: The dog"
                          />
                        </div>
                      </div>
                    </div>

                    {/* Context */}
                    <div className="col-span-1 md:col-span-3 lg:col-span-1 space-y-4">
                       <div className="bg-purple-50 p-4 rounded-lg border border-purple-100">
                        <h3 className="font-bold text-purple-900 mb-2">Interpersonal: Context</h3>
                        <p className="text-xs text-purple-700 mb-3">Mood and social relationship.</p>
                        <textarea 
                           value={state.functionalNotes.context}
                           onChange={(e) => setState({...state, functionalNotes: {...state.functionalNotes, context: e.target.value}})}
                           className="w-full p-2 border border-purple-200 rounded bg-white text-sm h-32"
                           placeholder="Analyze mood (Declarative? Imperative?) and the speaker's stance."
                        />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* --- VIEW: TG GRAMMAR --- */}
              {activeTab === 'tg' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-start">
                    <h2 className="text-lg font-bold text-slate-800">Transformational-Generative Grammar</h2>
                    <button onClick={() => setShowInfo('tg')} className="text-indigo-600 hover:text-indigo-800 flex items-center gap-1 text-sm font-medium">
                      <Info size={16} /> Chomsky's Framework
                    </button>
                  </div>

                  <div className="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                    <h3 className="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-slate-400"></div> Surface Structure
                    </h3>
                    <div className="text-2xl font-mono text-slate-800 bg-slate-50 p-4 rounded border border-slate-200">
                      {state.sentence}
                    </div>
                  </div>

                  <div className="flex flex-col items-center justify-center py-2 text-slate-400">
                    <div className="flex items-center gap-2">
                      <span className="text-xs uppercase font-bold tracking-widest">Transformations</span>
                      <ChevronDown />
                    </div>
                  </div>

                  <div className="bg-slate-50 p-6 rounded-lg border border-slate-200">
                     <h3 className="font-semibold text-slate-700 mb-2">Applied Transformations (T-Rules)</h3>
                     <div className="flex flex-wrap gap-2 mb-4">
                       {['Passive', 'Negative', 'Question', 'Affix Hopping', 'Do-support'].map(t => (
                         <button 
                           key={t}
                           onClick={() => {
                             const hasT = state.tgNotes.transformations.includes(t);
                             const newTs = hasT 
                              ? state.tgNotes.transformations.filter(x => x !== t)
                              : [...state.tgNotes.transformations, t];
                             setState({...state, tgNotes: {...state.tgNotes, transformations: newTs}});
                           }}
                           className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${
                             state.tgNotes.transformations.includes(t)
                               ? 'bg-indigo-600 text-white border-indigo-600'
                               : 'bg-white text-slate-600 border-slate-300 hover:border-indigo-400'
                           }`}
                         >
                           {t}
                         </button>
                       ))}
                     </div>
                  </div>

                  <div className="flex flex-col items-center justify-center py-2 text-slate-400">
                    <div className="flex items-center gap-2">
                      <ChevronDown />
                      <span className="text-xs uppercase font-bold tracking-widest">Derived From</span>
                    </div>
                  </div>

                  <div className="bg-slate-900 p-6 rounded-lg border border-slate-800 text-green-400 font-mono shadow-inner">
                    <label className="block text-xs uppercase font-bold text-slate-500 mb-2">Deep Structure</label>
                    <input 
                      type="text"
                      value={state.tgNotes.deepStructure}
                      onChange={(e) => setState({...state, tgNotes: {...state.tgNotes, deepStructure: e.target.value}})}
                      className="w-full bg-transparent border-b border-slate-700 focus:border-green-500 outline-none py-2"
                      placeholder="e.g., [S [NP The girl] [VP [V chase] [NP the dog]]]"
                    />
                  </div>

                  {/* Transformation Playground */}
                  <div className="mt-8 pt-8 border-t border-slate-200">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="font-bold text-slate-800 flex items-center gap-2">
                          <ArrowRightLeft size={16} /> Transformation Playground
                        </h4>
                        <button
                          onClick={handleGenerateVariations}
                          disabled={isGeneratingVars}
                          className="flex items-center gap-2 text-xs font-bold text-indigo-600 border border-indigo-200 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100 transition-colors"
                        >
                          {isGeneratingVars ? <RefreshCw className="animate-spin w-3 h-3"/> : <Wand2 size={12} />}
                          ✨ Generate Variations
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="p-4 bg-orange-50 rounded-lg border border-orange-100">
                        <p className="text-xs font-bold text-orange-800 uppercase mb-2">To Passive</p>
                        <input 
                          className="w-full bg-white border border-orange-200 rounded px-3 py-2 text-sm" 
                          placeholder="Rewrite as passive..." 
                          defaultValue={generatedVars.passive}
                        />
                      </div>
                      <div className="p-4 bg-sky-50 rounded-lg border border-sky-100">
                        <p className="text-xs font-bold text-sky-800 uppercase mb-2">To Interrogative</p>
                        <input 
                          className="w-full bg-white border border-sky-200 rounded px-3 py-2 text-sm" 
                          placeholder="Rewrite as question..."
                          defaultValue={generatedVars.question}
                        />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* --- VIEW: SYNTHESIS --- */}
              {activeTab === 'explain' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-center">
                    <h2 className="text-lg font-bold text-slate-800">Synthesis & Explanation</h2>
                    <button 
                       onClick={handleGenerateSynthesis}
                       className="text-sm text-indigo-600 font-medium flex items-center gap-2 hover:bg-indigo-50 px-3 py-1 rounded transition-colors"
                    >
                        <Sparkles size={14}/> ✨ Draft Explanation
                    </button>
                  </div>
                  <p className="text-slate-600">
                    Combine your findings. Explain why this structure is chosen over alternatives (Active vs Passive, Simple vs Complex).
                    Avoid test-style answers; focus on the <em>effect</em> of the structure.
                  </p>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-4">
                       <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                         <h4 className="font-bold text-slate-700 mb-2 text-sm uppercase">Analysis Summary</h4>
                         <ul className="text-sm space-y-2 text-slate-600 list-disc pl-4">
                           <li><strong>Theme:</strong> {state.functionalNotes.theme || "Not analyzed"}</li>
                           <li><strong>Process:</strong> {state.functionalNotes.process || "Not analyzed"}</li>
                           <li><strong>Transformations:</strong> {state.tgNotes.transformations.join(", ") || "None"}</li>
                         </ul>
                       </div>
                       
                       <div className="bg-white p-4 rounded-lg border border-slate-200">
                         <h4 className="font-bold text-slate-700 mb-2 text-sm">Guided Reflection</h4>
                         <ul className="text-sm space-y-3 text-slate-600">
                           <li className="flex gap-2 items-start"><ChevronRight size={14} className="mt-1" /> Why was this Theme chosen? What does it foreground?</li>
                           <li className="flex gap-2 items-start"><ChevronRight size={14} className="mt-1" /> How would the meaning change if the Deep Structure was transformed differently (e.g., Passive)?</li>
                         </ul>
                       </div>
                    </div>

                    <div className="h-full">
                      <textarea 
                        className="w-full h-full min-h-[300px] p-6 text-base leading-relaxed bg-white border-2 border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-0 transition-all outline-none resize-none shadow-inner"
                        placeholder="Write your comprehensive analysis here..."
                        value={state.explanation}
                        onChange={(e) => setState({...state, explanation: e.target.value})}
                      />
                    </div>
                  </div>
                </div>
              )}

            </div>
          </div>
        )}

        {!state.sentence && (
          <div className="text-center py-20 text-slate-400">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Type size={32} className="text-slate-300" />
            </div>
            <p className="text-lg">Enter a sentence above or click <span className="font-bold text-indigo-500 cursor-pointer" onClick={loadDemo}>Demo</span> to begin.</p>
          </div>
        )}
      </main>
    </div>
  );
}
